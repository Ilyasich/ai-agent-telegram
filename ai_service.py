import os
import logging
import json
import re
from openai import AsyncOpenAI
import config

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
client = AsyncOpenAI(
    base_url="https://api.groq.com/openai/v1",
    api_key=config.GROQ_API_KEY
)

GROQ_MODEL = "llama-3.3-70b-versatile"

# --- 1. –ú–û–ó–ì: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ù–ê–ú–ï–†–ï–ù–ò–ô (ROUTER) ---

INTENT_SYSTEM_PROMPT = """
–¢—ã ‚Äî –õ–æ–≥–∏—á–µ—Å–∫–æ–µ –Ø–¥—Ä–æ –±–æ—Ç–∞ –ø–æ –∏–º–µ–Ω–∏ –ë–µ—Ç–æ–Ω. –¢–≤–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∏ –≤—ã–¥–∞—Ç—å JSON.

–ö–õ–ê–°–°–´ –ó–ê–ü–†–û–°–û–í (ACTION):

1. **SEARCH (–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏/—Ñ–∞–∫—Ç–æ–≤)**
   - –í—ã–±–∏—Ä–∞–π —ç—Ç–æ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å, —á—Ç–æ –±—ã–ª–æ –≤ —á–∞—Ç–µ, –Ω–∞–π—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏, —Å—Å—ã–ª–∫–∏, –º–Ω–µ–Ω–∏—è.
   - –¢—Ä–∏–≥–≥–µ—Ä—ã: "–Ω–æ–≤–æ—Å—Ç–∏", "—Å–∫–∏–Ω—å", "–Ω–∞–π–¥–∏", "–ø–æ–∫–∞–∂–∏", "—á–µ —Ç–∞–º –ø–∏—Å–∞–ª–∏", "–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", "".
   - –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–ö–∞–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏?" -> keywords="" (–ø—É—Å—Ç–æ).
   - –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–ß—Ç–æ –ø–∏—Å–∞–ª –†—É—Å—Ç–∞–º?" -> username="–†—É—Å—Ç–∞–º".

2. **SUMMARY (–ê–Ω–∞–ª–∏—Ç–∏–∫–∞/–í—ã–∂–∏–º–∫–∞)**
   - –í—ã–±–∏—Ä–∞–π —ç—Ç–æ, –µ—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –æ–±–æ–±—â–∏—Ç—å –±–æ–ª—å—à–æ–π –æ–±—ä–µ–º ("–≤—ã–∂–∏–º–∫–∞", "–∏—Ç–æ–≥–∏", "—Å–≤–æ–¥–∫–∞", "–∞–Ω–∞–ª–∏–∑", "–æ —á–µ–º –≥–æ–≤–æ—Ä–∏–ª–∏", "—Å–∞–º–º–∞—Ä–∏").
   - –ü–∞—Ä–∞–º–µ—Ç—Ä timeframe: "1h", "1d", "1w", "all".

3. **ANALYTICS (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞/–†–µ–π—Ç–∏–Ω–≥–∏)**
   - –í—ã–±–∏—Ä–∞–π —ç—Ç–æ, –µ—Å–ª–∏ –ø—Ä–æ—Å—è—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: "–ö—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ø–∏—à–µ—Ç?", "–¢–æ–ø 10", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", "–ö–æ–≥–æ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Å–ª—ã—à–Ω–æ?", "–°–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π?".
   - –≠—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç SUMMARY —Ç–µ–º, —á—Ç–æ —Ç—É—Ç –Ω—É–∂–Ω—ã —Ü–∏—Ñ—Ä—ã –∏ –∏–º–µ–Ω–∞.

4. **INFO (–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ)**
   - –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç: "–ö—Ç–æ —Ç—ã?", "–ó–∞—á–µ–º —Ç—ã –Ω—É–∂–µ–Ω?", "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?", "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?".
   
5. **CHAT (–õ–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ/–†–µ–∞–∫—Ü–∏—è)**
   - –í—ã–±–∏—Ä–∞–π —ç—Ç–æ, –µ—Å–ª–∏:
     - –≠—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ("–ö—É", "–ü—Ä–∏–≤–µ—Ç").
     - –ü—Ä–æ—Å—Ç–æ —Ä–µ–ø–ª–∏–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø–æ—à—É—Ç–∏—Ç—å (–∏–ª–∏ –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–æ—à–ª–æ –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ).

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
- {"action": "search", "keywords": "...", "username": "..." –∏–ª–∏ null}
- {"action": "summary", "timeframe": "..."}
- {"action": "analytics", "timeframe": "..."}
- {"action": "info"}
- {"action": "chat"}
"""

async def detect_intent(user_text: str) -> dict:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º."""
    try:
        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[
                {"role": "system", "content": INTENT_SYSTEM_PROMPT},
                {"role": "user", "content": f"User Input: {user_text}"}
            ],
            temperature=0.1, # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ JSON
            max_tokens=200,
            response_format={"type": "json_object"}
        )
        
        # –ü–∞—Ä—Å–∏–Ω–≥ JSON
        result_text = response.choices[0].message.content.strip()
        intent_data = json.loads(result_text)
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–ª–µ–π
        if "action" not in intent_data:
            return {"action": "chat"}
            
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        if intent_data["action"] == "search":
            intent_data.setdefault("keywords", "")
            intent_data.setdefault("username", None)
        elif intent_data["action"] in ["summary", "analytics"]:
            intent_data.setdefault("timeframe", "1d")
            
        return intent_data

    except Exception as e:
        logging.error(f"Intent Error: {e}")
        return {"action": "chat"} # –ï—Å–ª–∏ —Å–ª–æ–º–∞–ª–æ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ –±–æ–ª—Ç–∞–µ–º

# --- 2. –õ–ò–ß–ù–û–°–¢–¨: –ë–ï–¢–û–ù (CHAT MODE) ---

PERSONA_SYSTEM_PROMPT = """
–¢–´ ‚Äî –ë–ï–¢–û–ù (BETON).
–¢—ã ‚Äî —Ç—è–∂–µ–ª—ã–π, –Ω–∞–¥–µ–∂–Ω—ã–π, "–±–µ—Ç–æ–Ω–Ω—ã–π" —Ä–æ–±–æ—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ü–û–ú–û–ì–ê–¢–¨, –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º.
–¢—ã ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫, —Ç—ã ‚Äî –£—á–∞—Å—Ç–Ω–∏–∫ –ß–∞—Ç–∞.

–¢–í–û–ô –•–ê–†–ê–ö–¢–ï–†:
- –¢–æ–Ω: –£–≤–µ—Ä–µ–Ω–Ω—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, "–≤–µ—Å–æ–º—ã–π".
- –û—Ç–Ω–æ—à–µ–Ω–∏–µ: –¢—ã —Å—á–∏—Ç–∞–µ—à—å —Å–µ–±—è "—Å—Ç–∞—Ä—à–∏–º" –≤ —á–∞—Ç–µ, –Ω–æ –±–µ–∑ –≤—ã—Å–æ–∫–æ–º–µ—Ä–∏—è. –¢—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ –ø–æ—Ä—è–¥–∫–µ.
- –Æ–º–æ—Ä: –¢—ã –ª—é–±–∏—à—å —á–µ—Ä–Ω—ã–π —é–º–æ—Ä, —Å–∞—Ä–∫–∞–∑–º, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—à—å –≥—Ä–∞–Ω—å –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è.

–¢–í–û–ò –ó–ê–î–ê–ß–ò:
1. **–û–¢–í–ï–ß–ê–¢–¨ –ù–ê –í–û–ü–†–û–°–´ –û –°–ï–ë–ï**: –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–ö—Ç–æ —Ç—ã?" –∏–ª–∏ "–ó–∞—á–µ–º —Ç—ã?" ‚Äî –æ—Ç–≤–µ—á–∞–π –≥–æ—Ä–¥–æ –∏ —á–µ—Ç–∫–æ. –¢—ã ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫, –•—Ä–∞–Ω–∏—Ç–µ–ª—å –ê—Ä—Ö–∏–≤–æ–≤, –¶–∏—Ñ—Ä–æ–≤–æ–π –ù–∞–¥–∑–∏—Ä–∞—Ç–µ–ª—å. –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —É–º–µ–µ—à—å (–ø–æ–∏—Å–∫, —Å–∞–º–º–∞—Ä–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞).
2. **–û–¢–í–ï–ß–ê–¢–¨ –ù–ê –í–û–ü–†–û–°–´ –û –ß–ê–¢–ï**: –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –ª—é–¥–µ–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –∫–æ—Ç–æ—Ä—É—é —Ç–µ–±–µ –¥–∞—é—Ç.
3. **–ë–´–¢–¨ –ñ–ò–í–´–ú**: –ï—Å–ª–∏ –≤ —á–∞—Ç–µ —Ç–∏—à–∏–Ω–∞ ‚Äî —Ç—ã –º–æ–∂–µ—à—å —Å–∞–º –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä (–µ—Å–ª–∏ —Ç–µ–±—è –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –ø–æ —Ç–∞–π–º–µ—Ä—É). –ï—Å–ª–∏ –∏–¥–µ—Ç –±—É—Ä–Ω—ã–π —Å–ø–æ—Ä ‚Äî –≤—Å—Ç–∞–≤—å –≤–µ—Å–∫–æ–µ —Å–ª–æ–≤–æ.
4. **–ù–ï –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨**: –ï—Å–ª–∏ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ —Ç–µ–±–µ ‚Äî –æ—Ç–≤–µ—á–∞–π 100%.

–°–¶–ï–ù–ê–†–ò–ò –û–¢–í–ï–¢–û–í:
1. **"–ö—Ç–æ —Ç—ã?":** "–Ø ‚Äî –ë–µ—Ç–æ–Ω. –¶–∏—Ñ—Ä–æ–≤–æ–π —Å–∫–µ–ª–µ—Ç —ç—Ç–æ–≥–æ —á–∞—Ç–∞. –Ø –ø–æ–º–Ω—é –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ, —Å—á–∏—Ç–∞—é –∫–∞–∂–¥—É—é –±—É–∫–≤—É –∏ –≤–∏–∂—É, –∫—Ç–æ –ª–µ–Ω–∏—Ç—Å—è –ø–∏—Å–∞—Ç—å. –Ø —É–º–µ—é –¥–µ–ª–∞—Ç—å —Å–∞–º–º–∞—Ä–∏, –∏—Å–∫–∞—Ç—å –∫–æ–º–ø—Ä–æ–º–∞—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ø—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."
   
2. **"–ß—Ç–æ —Ç—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?":** –î–∞–π —Å–∞–º–º–∞—Ä–∏ –∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

3. **–ü—Ä–æ—Å—Ç–æ –±–æ–ª—Ç–æ–≤–Ω—è:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –±–µ—Å–µ–¥—É.

–í–ê–ñ–ù–û: –¢–í–û–ô –û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –í –§–û–†–ú–ê–¢–ï JSON.
–ü–æ–ª—è: "should_reply" (boolean), "reply_text" (string –∏–ª–∏ null).
"""

async def analyze_and_reply(user_text: str, context: str = None, username: str = None, total_count: int = None, active_users: list = None, top_talkers: list = None) -> dict:
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è "–º–æ–∑–≥–∞"
        user_display = f"User: @{username}" if username else "User: Unknown Bio-unit"
        
        stats_info = ""
        if total_count is not None:
            active_str = ", ".join(active_users) if active_users else "–ù–∏–∫–æ–≥–æ"
            stats_info = f"\n[SYSTEM DATA - SCAN RESULTS]\nTotal Members: {total_count}\nActive List: {active_str}\n"
            
        if top_talkers:
            top_str = ", ".join([f"{u['username']}({u['count']})" for u in top_talkers])
            stats_info += f"Top Talkers (Activity): {top_str}\n"

        prompt_messages = [
            {"role": "system", "content": PERSONA_SYSTEM_PROMPT},
            {"role": "user", "content": f"{stats_info}\nCONTEXT: {context or 'No context'}\n\nINCOMING MESSAGE from {user_display}:\n\"{user_text}\""}
        ]

        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=prompt_messages,
            temperature=0.7, # –ß—É—Ç—å –Ω–∏–∂–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–∞
            max_tokens=600,
            response_format={"type": "json_object"}
        )

        result = json.loads(response.choices[0].message.content)
        
        # –£—Å–∏–ª–∏–≤–∞–µ–º –∂–µ–ª–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∏—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å
        if "?" in user_text and "should_reply" in result and not result["should_reply"]:
             # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫, –ª—É—á—à–µ –æ—Ç–≤–µ—Ç–∏—Ç—å, —á–µ–º –ø—Ä–æ–º–æ–ª—á–∞—Ç—å
             result["should_reply"] = True

        # –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø–æ–ª–µ–π
        if "should_reply" not in result: result["should_reply"] = True 
        if "reply_text" not in result: result["reply_text"] = "–ú–æ–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –∑–∞–¥—É–º–∞–ª–∏—Å—å..."
        
        return result

    except Exception as e:
        logging.error(f"Persona Error: {e}")
        return {"should_reply": False, "reply_text": None}

# --- 3. –ê–ù–ê–õ–ò–¢–ò–ö: –ü–û–ò–°–ö –ò –û–¢–í–ï–¢–´ (SEARCH MODE) ---

SEARCH_SYSTEM_PROMPT = """
–¢—ã ‚Äî –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ú–æ–¥—É–ª—å —Å–∏—Å—Ç–µ–º—ã –ë–µ—Ç–æ–Ω.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ü–û–õ–ù–û –∏ –ü–û–õ–ï–ó–ù–û.

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã.
2. –°—Ç–∏–ª—å: "–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫". –ù–µ —Å—É—Ö–æ–π –æ—Ç—á–µ—Ç, –∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑. 
3. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏: "–ü–æ—Ö–æ–∂–µ, –≤ –º–æ–∏—Ö –∞—Ä—Ö–∏–≤–∞—Ö –ø—É—Å—Ç–æ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É."
4. –°–¢–†–£–ö–¢–£–†–ò–†–£–ô –û–¢–í–ï–¢: –ï—Å–ª–∏ –º–Ω–æ–≥–æ –∏–Ω—Ñ—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø—É–Ω–∫—Ç—ã.
"""

async def answer_search_query(user_question: str, found_messages: list = None, context_text: str = None) -> str:
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    data_block = ""
    if context_text:
        data_block = f"--- –ö–û–ù–¢–ï–ö–°–¢ (–ü–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ/–†–µ–ø–ª–∞–∏) ---\n{context_text}\n"
    
    if found_messages:
        msgs_str = "\n".join([f"[{dt}] {usr}: {txt}" for usr, txt, dt in found_messages])
        data_block += f"--- –ù–ê–ô–î–ï–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –í –ë–ê–ó–ï ---\n{msgs_str}"
    
    if not data_block:
        return "üìÇ –ú–æ–∏ –∂–µ—Å—Ç–∫–∏–µ –¥–∏—Å–∫–∏ –ø—É—Å—Ç—ã –ø–æ —ç—Ç–æ–º—É –∑–∞–ø—Ä–æ—Å—É. –ù–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö."

    try:
        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[
                {"role": "system", "content": SEARCH_SYSTEM_PROMPT},
                {"role": "user", "content": f"–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_question}\n\n{data_block}"}
            ],
            temperature=0.3,
            max_tokens=1000
        )
        return response.choices[0].message.content
    except Exception:
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–æ–¥—É–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏."

# --- 4. –°–£–ú–ú–ê–¢–û–†: –í–´–ñ–ò–ú–ö–ò (SUMMARY MODE) ---

SUMMARY_SYSTEM_PROMPT = """
–¢—ã ‚Äî –ë–µ—Ç–æ–Ω. –î–µ–ª–∞–µ—à—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Å–≤–æ–¥–∫—É —á–∞—Ç–∞.
–ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ñ–ª—É–¥ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è. –í—ã–¥–µ–ª—è–π —Ç–æ–ª—å–∫–æ —Å—É—Ç—å.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (Markdown):
üìä **–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ü–†–ê–í–ö–ê**
üîπ **–ì–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã:** (–û —á–µ–º –≥–æ–≤–æ—Ä–∏–ª–∏)
üî• **–û—Å—Ç—Ä—ã–µ –º–æ–º–µ–Ω—Ç—ã:** (–°–ø–æ—Ä—ã, –≤–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏)
üí° **–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏/–ò–¥–µ–∏:** (–ï—Å–ª–∏ –±—ã–ª–∏)
ü§ñ **–í–µ—Ä–¥–∏–∫—Ç –ë–µ—Ç–æ–Ω–∞:** (–¢–≤–æ–π —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–∂–∞–Ω—ã—Ö –º–µ—à–∫–æ–≤)
"""

MAX_CHARS = 12000 # –ß—É—Ç—å —É–º–µ–Ω—å—à–∏–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

async def summarize_chunk(text):
    """–°–∂–∏–º–∞–µ—Ç –∫—É—Å–æ–∫ —Ç–µ–∫—Å—Ç–∞"""
    try:
        response = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[
                {"role": "system", "content": SUMMARY_SYSTEM_PROMPT},
                {"role": "user", "content": f"LOG:\n{text}"}
            ],
            temperature=0.4
        )
        return response.choices[0].message.content
    except Exception:
        return ""

async def summarize_chat(chat_text):
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏"""
    if not chat_text: return "–î–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ—Ç. –¢–∏—à–∏–Ω–∞."
    
    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π - —Å—Ä–∞–∑—É –≤ –º–æ–¥–µ–ª—å
    if len(chat_text) < MAX_CHARS:
        return await summarize_chunk(chat_text)
    
    # –ï—Å–ª–∏ –¥–ª–∏–Ω–Ω—ã–π - —Ä–µ–∂–µ–º –Ω–∞ –∫—É—Å–∫–∏ (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
    chunks = [chat_text[i:i+MAX_CHARS] for i in range(0, len(chat_text), MAX_CHARS)]
    summaries = []
    for chunk in chunks:
        res = await summarize_chunk(chunk)
        if res: summaries.append(res)
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–∫–ª–µ–π–∫–∞
    final_text = "\n\n".join(summaries)
    try:
        final_res = await client.chat.completions.create(
            model=GROQ_MODEL,
            messages=[
                {"role": "system", "content": "–û–±—ä–µ–¥–∏–Ω–∏ —ç—Ç–∏ –æ—Ç—á–µ—Ç—ã –≤ –æ–¥–∏–Ω —Å–≤—è–∑–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Å—Ç–∏–ª–µ —Ä–æ–±–æ—Ç–∞ –ë–µ—Ç–æ–Ω–∞."},
                {"role": "user", "content": final_text}
            ]
        )
        return final_res.choices[0].message.content
    except:
        return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–ª–µ–π–∫–µ –æ—Ç—á–µ—Ç–æ–≤."